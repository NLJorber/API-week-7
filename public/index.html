<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medication Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              400: '#38bdf8',
              500: '#0ea5e9',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 px-6 py-6">
  <header class="mb-4 space-y-1">
    <h1 class="text-2xl font-semibold">Medication Manager</h1>
    <h3 class="text-sm text-slate-400">Test the API with a tiny UI. Use /auth/login first.</h3>
    <div id="auth-status" class="rounded-lg border border-slate-800 bg-slate-900 px-3 py-2 text-sm">Not authenticated</div>
  </header>

  <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
    <section class="rounded-xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-black/40">
      <h2 class="text-lg font-semibold mb-2">Auth</h2>
      <form id="login-form" class="space-y-3">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="text-sm text-slate-400 space-y-1">
            <span>Email</span>
            <input id="login-email" type="email" placeholder="you@example.com" required class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
          <label class="text-sm text-slate-400 space-y-1">
            <span>Password</span>
            <input id="login-password" type="password" placeholder="password" required class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
        </div>
        <div class="flex flex-wrap gap-2">
          <button type="submit" class="rounded-lg bg-gradient-to-r from-brand-400 to-brand-500 px-4 py-2 text-sm font-semibold text-slate-950 shadow hover:opacity-90">Login</button>
          <button type="button" class="rounded-lg border border-slate-800 px-4 py-2 text-sm text-slate-200 hover:border-brand-400" id="signup-btn">Quick Sign Up</button>
          <button type="button" class="rounded-lg border border-slate-800 px-4 py-2 text-sm text-slate-200 hover:border-brand-400" id="logout-btn">Logout</button>
        </div>
      </form>
    </section>

    <section class="rounded-xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-black/40 xl:col-span-2">
      <h2 class="text-lg font-semibold mb-2">Create / Update Med</h2>
      <form id="med-form" class="space-y-3">
        <label class="text-sm text-slate-400 space-y-1">
          <span>Med ID (leave blank to create)</span>
          <input id="med-id" type="text" placeholder="Existing ID to update" class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
        </label>
        <div class="grid md:grid-cols-2 gap-3">
          <label class="text-sm text-slate-400 space-y-1">
            <span>Name</span>
            <input id="med-name" required class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
          <label class="text-sm text-slate-400 space-y-1">
            <span>Dosage</span>
            <input id="med-dosage" required class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <label class="text-sm text-slate-400 space-y-1">
            <span>Time To Take</span>
            <input id="med-time" placeholder="08:00 AM" required class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
          <label class="text-sm text-slate-400 space-y-1">
            <span>Frequency</span>
            <input id="med-frequency" placeholder="Daily" required class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <label class="text-sm text-slate-400 space-y-1">
            <span>Profile ID (optional)</span>
            <input id="med-profile" placeholder="Profile ObjectId" class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
          <label class="text-sm text-slate-400 space-y-1">
            <span>Quantity</span>
            <input id="med-quantity" type="number" value="0" class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <label class="text-sm text-slate-400 space-y-1">
            <span>Low Stock Threshold</span>
            <input id="med-threshold" type="number" value="0" class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
          <label class="text-sm text-slate-400 space-y-1">
            <span>Notes</span>
            <input id="med-notes" placeholder="Optional notes" class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
        </div>
        <button type="submit" class="rounded-lg bg-gradient-to-r from-brand-400 to-brand-500 px-4 py-2 text-sm font-semibold text-slate-950 shadow hover:opacity-90">Save Med</button>
      </form>
    </section>

    <section class="rounded-xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-black/40">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Reminders</h2>
        <button type="button" id="refresh-reminders" class="rounded-lg border border-slate-800 px-3 py-1.5 text-sm text-slate-200 hover:border-brand-400">Refresh</button>
      </div>
      <form id="reminder-form" class="space-y-3">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="text-sm text-slate-400 space-y-1">
            <span>Message</span>
            <input id="reminder-message" required class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
          <label class="text-sm text-slate-400 space-y-1">
            <span>Med ID (optional)</span>
            <input id="reminder-med" placeholder="Link to medication" class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
          </label>
        </div>
        <label class="text-sm text-slate-400 space-y-1">
          <span>Due At</span>
          <input id="reminder-due" type="datetime-local" required class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:border-brand-400 focus:ring-1 focus:ring-brand-400" />
        </label>
        <button type="submit" class="rounded-lg bg-gradient-to-r from-brand-400 to-brand-500 px-4 py-2 text-sm font-semibold text-slate-950 shadow hover:opacity-90">Create Reminder</button>
      </form>
      <div id="reminders-list" class="mt-3 space-y-2"></div>
    </section>
  </div>

  <section class="mt-4 rounded-xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-black/40">
    <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
      <h2 class="text-lg font-semibold">Medications</h2>
      <button type="button" class="rounded-lg border border-slate-800 px-3 py-1.5 text-sm text-slate-200 hover:border-brand-400" id="load-meds">Load Meds</button>
    </div>
    <div id="meds-list" class="space-y-2"></div>
  </section>

  <div id="messages" class="mt-3 space-y-2"></div>

  <script>
    const messagesEl = document.getElementById("messages");
    const authStatusEl = document.getElementById("auth-status");
    let token = localStorage.getItem("token") || "";

    function setMessage(text, type = "") {
      const el = document.createElement("div");
      const base = "rounded-lg border px-3 py-2 text-sm";
      const variants = {
        "": "border-slate-800 bg-slate-900 text-slate-200",
        danger: "border-red-500/40 bg-red-500/10 text-red-100",
        success: "border-emerald-500/40 bg-emerald-500/10 text-emerald-100"
      };
      el.className = base + " " + (variants[type] || variants[""]);
      el.textContent = text;
      messagesEl.prepend(el);
      setTimeout(() => el.remove(), 6000);
    }

    function updateAuthStatus() {
      if (token) {
        authStatusEl.textContent = "Authenticated";
        authStatusEl.className = "rounded-lg border border-emerald-500/40 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-100";
      } else {
        authStatusEl.textContent = "Not authenticated";
        authStatusEl.className = "rounded-lg border border-slate-800 bg-slate-900 px-3 py-2 text-sm text-slate-200";
      }
    }

    updateAuthStatus();

    async function api(path, { method = "GET", body, headers = {} } = {}) {
      const opts = { method, headers: { ...headers } };
      if (body !== undefined) {
        opts.body = typeof body === "string" ? body : JSON.stringify(body);
        opts.headers["Content-Type"] = "application/json";
      }
      if (token) {
        opts.headers["Authorization"] = "Bearer " + token;
      }
      const res = await fetch(path, opts);
      const text = await res.text();
      let data = {};
      if (text) {
        try { data = JSON.parse(text); } catch (_) { data = { raw: text }; }
      }
      if (!res.ok) {
        throw new Error(data.message || res.statusText);
      }
      return data;
    }

    // Auth
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      try {
        const data = await api("/auth/login", { method: "POST", body: { email, password } });
        token = data.token;
        localStorage.setItem("token", token);
        updateAuthStatus();
        setMessage("Logged in", "success");
        loadMeds();
        loadReminders();
      } catch (error) {
        setMessage(error.message, "danger");
      }
    });

    document.getElementById("signup-btn").addEventListener("click", async () => {
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value || "password123";
      const name = email.split("@")[0] || "User";
      try {
        await api("/auth/signup", { method: "POST", body: { email, password, name } });
        setMessage("Signup success, now log in.", "success");
      } catch (error) {
        setMessage(error.message, "danger");
      }
    });

    document.getElementById("logout-btn").addEventListener("click", () => {
      token = "";
      localStorage.removeItem("token");
      updateAuthStatus();
      setMessage("Logged out");
    });

    // Med create/update
    document.getElementById("med-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("med-id").value.trim();
      const body = {
        name: document.getElementById("med-name").value,
        dosage: document.getElementById("med-dosage").value,
        timeToTake: document.getElementById("med-time").value,
        frequency: document.getElementById("med-frequency").value,
        notes: document.getElementById("med-notes").value,
        profileId: document.getElementById("med-profile").value || undefined,
        quantity: Number(document.getElementById("med-quantity").value || 0),
        lowStockThreshold: Number(document.getElementById("med-threshold").value || 0),
      };
      try {
        if (id) {
          await api(`/${id}`, { method: "PUT", body });
          setMessage("Medication updated", "success");
        } else {
          await api("/", { method: "POST", body });
          setMessage("Medication created", "success");
        }
        loadMeds();
      } catch (error) {
        setMessage(error.message, "danger");
      }
    });

    // Load meds
    document.getElementById("load-meds").addEventListener("click", () => loadMeds());

    async function loadMeds() {
      try {
        const meds = await api("/");
        renderMeds(meds);
      } catch (error) {
        setMessage(error.message, "danger");
      }
    }

    function renderMeds(meds) {
      const container = document.getElementById("meds-list");
      if (!Array.isArray(meds) || meds.length === 0) {
        container.innerHTML = '<div class="muted">No meds found</div>';
        return;
      }
      container.innerHTML = "";
      meds.forEach((med) => {
        const card = document.createElement("div");
        const low = med.quantity !== undefined && med.lowStockThreshold !== undefined && med.quantity <= med.lowStockThreshold;
        card.className = "rounded-xl border border-slate-800 bg-slate-950 px-3 py-3";
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold text-slate-100">${med.name}</div>
              <div class="text-xs text-slate-400">${med.dosage} • ${med.frequency} • ${med.timeToTake}</div>
            </div>
            <span class="inline-flex items-center rounded-full border px-2 py-1 text-xs ${low ? "border-red-500/50 text-red-200" : "border-slate-700 text-slate-300"}">
              Qty: ${med.quantity ?? 0}
            </span>
          </div>
          <div class="text-xs text-slate-400 mt-2">${med.notes || ""}</div>
          <div class="text-xs text-slate-500 mt-1">Profile: ${med.profileId || "n/a"}</div>
          <div class="text-xs text-slate-500 mt-1">Last skipped: ${med.lastSkippedAt ? new Date(med.lastSkippedAt).toLocaleString() : "never"}</div>
          <div class="flex flex-wrap items-center gap-2 mt-3">
            <button data-action="skip" data-id="${med._id}" class="rounded-lg bg-brand-500/90 px-3 py-1.5 text-xs font-semibold text-slate-950 hover:opacity-90">Skip dose</button>
            <button data-action="delete" data-id="${med._id}" class="rounded-lg border border-red-500/50 px-3 py-1.5 text-xs text-red-100 hover:bg-red-500/10">Delete</button>
            <div class="flex items-center gap-2">
              <input data-id="${med._id}" data-role="inventory-amount" class="w-24 rounded-lg border border-slate-800 bg-slate-900 px-2 py-1 text-xs" type="number" placeholder="+/- qty" />
              <button data-action="inventory" data-id="${med._id}" class="rounded-lg border border-slate-800 px-3 py-1.5 text-xs text-slate-200 hover:border-brand-400">Adjust Inventory</button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });

      container.querySelectorAll("button[data-action]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const action = btn.getAttribute("data-action");
          try {
            if (action === "delete") {
              await api(`/${id}`, { method: "DELETE" });
              setMessage("Deleted", "success");
            } else if (action === "skip") {
              await api(`/${id}/skip`, { method: "POST", body: { reason: "manual skip" } });
              setMessage("Marked skipped", "success");
            } else if (action === "inventory") {
              const input = container.querySelector(`input[data-role="inventory-amount"][data-id="${id}"]`);
              const amount = Number(input.value);
              if (Number.isNaN(amount)) return setMessage("Enter a number for inventory", "danger");
              await api(`/meds/${id}/inventory`, { method: "PATCH", body: { amount } });
              setMessage("Inventory updated", "success");
            }
            loadMeds();
          } catch (error) {
            setMessage(error.message, "danger");
          }
        });
      });
    }

    // Reminders
    document.getElementById("reminder-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const dueRaw = document.getElementById("reminder-due").value;
      const dueAt = dueRaw ? new Date(dueRaw).toISOString() : null;
      const body = {
        message: document.getElementById("reminder-message").value,
        medId: document.getElementById("reminder-med").value || undefined,
        dueAt
      };
      try {
        await api("/reminders", { method: "POST", body });
        setMessage("Reminder created", "success");
        loadReminders();
      } catch (error) {
        setMessage(error.message, "danger");
      }
    });

    document.getElementById("refresh-reminders").addEventListener("click", loadReminders);

    async function loadReminders() {
      try {
        const reminders = await api("/reminders");
        renderReminders(reminders);
      } catch (error) {
        setMessage(error.message, "danger");
      }
    }

    function renderReminders(reminders) {
      const container = document.getElementById("reminders-list");
      if (!Array.isArray(reminders) || reminders.length === 0) {
        container.innerHTML = '<div class="muted">No reminders</div>';
        return;
      }
      container.innerHTML = "";
      reminders.forEach((rem) => {
        const card = document.createElement("div");
        const due = rem.status === "due";
        card.className = "rounded-xl border border-slate-800 bg-slate-950 px-3 py-3";
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold text-slate-100">${rem.message}</div>
              <div class="text-xs text-slate-400">Due: ${new Date(rem.dueAt).toLocaleString()}</div>
            </div>
            <span class="inline-flex items-center rounded-full border px-2 py-1 text-xs ${due ? "border-amber-400/50 text-amber-200" : "border-slate-700 text-slate-300"}">
              ${rem.status}
            </span>
          </div>
          <div class="text-xs text-slate-500 mt-2">Med: ${rem.medId || "n/a"}</div>
          <div class="flex flex-wrap gap-2 mt-3">
            <button data-action="dismiss" data-id="${rem._id}" class="rounded-lg bg-brand-500/90 px-3 py-1.5 text-xs font-semibold text-slate-950 hover:opacity-90">Dismiss</button>
            <button data-action="mark-due" data-id="${rem._id}" class="rounded-lg border border-slate-800 px-3 py-1.5 text-xs text-slate-200 hover:border-brand-400">Mark Due</button>
          </div>
        `;
        container.appendChild(card);
      });

      container.querySelectorAll("button[data-action]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const action = btn.getAttribute("data-action");
          try {
            if (action === "dismiss") {
              await api(`/reminders/${id}/dismiss`, { method: "POST" });
            } else if (action === "mark-due") {
              await api(`/reminders/${id}/mark-due`, { method: "POST" });
            }
            loadReminders();
          } catch (error) {
            setMessage(error.message, "danger");
          }
        });
      });
    }

    // Auto load if token present
    if (token) {
      loadMeds();
      loadReminders();
    }
  </script>
</body>
</html>
